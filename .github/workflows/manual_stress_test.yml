name: Manual Stress Test

on:
  workflow_dispatch:
    inputs:
      train_window:
        description: 'Training window size (matches)'
        required: true
        default: '500'
      test_window:
        description: 'Test window size (matches)'
        required: true
        default: '50'
      step_size:
        description: 'Step size for rolling window'
        required: true
        default: '50'

jobs:
  stress-test:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas scikit-learn matplotlib seaborn
      
      - name: Collect maximum data
        run: |
          python collect_massive_historical_data.py
          wc -l data/historical/massive_training_data.csv
      
      - name: Train models
        run: |
          # Use advanced ML trainer if available, else fallback
          if [ -f train_advanced_ml_v2.py ]; then
            echo "üöÄ Using Advanced ML V2 trainer"
            python train_advanced_ml_v2.py
          else
            echo "‚öôÔ∏è  Using standard knowledge-enhanced trainer"
            python train_knowledge_enhanced_ml.py
          fi
      
      - name: Run customized stress test
        run: |
          python -c "
import sys
sys.path.insert(0, '.')
from src.testing.walk_forward_backtest import WalkForwardBacktester, SimpleGradientBoostModel
import pandas as pd

data = pd.read_csv('data/historical/massive_training_data.csv')
print(f'üìä Loaded {len(data)} matches')

backtester = WalkForwardBacktester(
    train_window=${{ github.event.inputs.train_window }},
    test_window=${{ github.event.inputs.test_window }},
    step_size=${{ github.event.inputs.step_size }},
    min_edge=0.08,
    kelly_fraction=0.25
)

results = backtester.run_backtest(
    data=data,
    model_class=SimpleGradientBoostModel,
    markets=['over_1_5', 'over_2_5', 'btts'],
    initial_bankroll=1000.0
)

backtester.print_results(results)
"
      
      - name: Run full stress test suite
        run: |
          python src/testing/stress_test.py
      
      - name: Upload all results
        uses: actions/upload-artifact@v4
        with:
          name: custom-stress-test-${{ github.run_number }}
          path: |
            data/stress_tests/**/*
            data/backtests/**/*
          retention-days: 90
