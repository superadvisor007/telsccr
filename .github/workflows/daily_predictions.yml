name: Daily Professional Soccer Predictions

on:
  schedule:
    # Run daily at 8 AM UTC (before most European matches)
    - cron: '0 8 * * *'
  
  workflow_dispatch:  # Allow manual trigger
    inputs:
      date:
        description: 'Date to predict (YYYY-MM-DD, leave empty for today)'
        required: false
        default: ''

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  professional-predictions:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üîÑ Check for trained models
        id: check_models
        run: |
          if [ -d "models/trained" ] && [ -f "models/trained/over_1_5_model.joblib" ]; then
            echo "models_exist=true" >> $GITHUB_OUTPUT
          else
            echo "models_exist=false" >> $GITHUB_OUTPUT
          fi
      
      - name: üéØ Train models (if needed)
        if: steps.check_models.outputs.models_exist == 'false'
        run: |
          echo "üîß No trained models found - training now..."
          python train_professional_models.py
      
      - name: üîç Fetch today's matches
        run: |
          python -c "
          import sys
          sys.path.append('.')
          from src.ingestion.api_client import FootballDataClient
          import json
          from datetime import datetime
          
          client = FootballDataClient()
          date = '${{ github.event.inputs.date }}' or datetime.now().strftime('%Y-%m-%d')
          matches = client.get_matches_by_date(date)
          
          with open('todays_matches.json', 'w') as f:
              json.dump(matches, f)
          
          print(f'‚úÖ Fetched {len(matches)} matches for {date}')
          "
      
      - name: ü§ñ Generate professional predictions
        run: |
          python -c "
          import sys
          sys.path.append('.')
          from pathlib import Path
          import json
          import pandas as pd
          from src.models.professional_model import ProfessionalSoccerModel
          from src.features.advanced_features import (
              EloRatingSystem, AdvancedFeatureEngineer, 
              ValueBettingCalculator, EloConfig
          )
          
          # Load trained models
          model = ProfessionalSoccerModel()
          model.load_models(Path('models/trained'))
          
          # Load today's matches
          with open('todays_matches.json', 'r') as f:
              matches = json.load(f)
          
          # Generate features for each match
          elo_system = EloRatingSystem(EloConfig())
          feature_engineer = AdvancedFeatureEngineer(elo_system)
          
          predictions = []
          
          for match in matches:
              # Extract match data
              home_team = match.get('home_team')
              away_team = match.get('away_team')
              
              # Build features (simplified - in production, fetch real stats)
              features = {
                  'elo_home': elo_system.get_rating(home_team),
                  'elo_away': elo_system.get_rating(away_team),
                  'elo_diff': elo_system.get_rating(home_team) - elo_system.get_rating(away_team),
                  'form_home': 50.0,  # Would be calculated from recent matches
                  'form_away': 50.0,
                  'home_goals_for_avg': 1.5,
                  'home_goals_against_avg': 1.2,
                  'away_goals_for_avg': 1.3,
                  'away_goals_against_avg': 1.4,
                  'total_goals_expected': 2.8
              }
              
              # Predict for all markets
              match_predictions = {
                  'home_team': home_team,
                  'away_team': away_team,
                  'match_time': match.get('match_time', 'TBD')
              }
              
              for market in ['over_1_5', 'over_2_5', 'btts', 'under_1_5']:
                  try:
                      pred = model.predict(features, market)
                      match_predictions[market] = pred
                  except:
                      pass
              
              predictions.append(match_predictions)
          
          # Save predictions
          with open('predictions.json', 'w') as f:
              json.dump(predictions, f, indent=2)
          
          print(f'‚úÖ Generated predictions for {len(predictions)} matches')
          "
      
      - name: üéØ Find value bets
        run: |
          python -c "
          import json
          from src.features.advanced_features import ValueBettingCalculator
          
          with open('predictions.json', 'r') as f:
              predictions = json.load(f)
          
          value_bets = []
          
          for pred in predictions:
              home = pred['home_team']
              away = pred['away_team']
              time = pred['match_time']
              
              for market in ['over_1_5', 'over_2_5', 'btts', 'under_1_5']:
                  if market in pred:
                      model_prob = pred[market]['probability']
                      
                      # Simulate market odds (in production, fetch real odds from bookmakers)
                      market_odds = 1.0 / (model_prob * 0.95)  # Bookmaker margin
                      
                      # Check for value
                      has_value = ValueBettingCalculator.has_value(
                          model_prob, market_odds, min_edge=0.05
                      )
                      
                      if has_value:
                          ev = ValueBettingCalculator.calculate_expected_value(
                              model_prob, market_odds, stake=10.0
                          )
                          
                          value_bets.append({
                              'match': f'{home} vs {away}',
                              'time': time,
                              'market': market,
                              'model_probability': f'{model_prob:.2%}',
                              'market_odds': f'{market_odds:.2f}',
                              'expected_value': f'{ev:+.2f}',
                              'edge': f'{(model_prob - 1/market_odds):.2%}'
                          })
          
          with open('value_bets.json', 'w') as f:
              json.dump(value_bets, f, indent=2)
          
          print(f'‚úÖ Found {len(value_bets)} value bets')
          "
      
      - name: üì± Send professional tips via Telegram
        run: |
          python -c "
          import requests
          import json
          import os
          from datetime import datetime
          
          with open('value_bets.json', 'r') as f:
              value_bets = json.load(f)
          
          if not value_bets:
              message = 'ü§ñ **Professional ML System**\n\n'
              message += f'üìÖ {datetime.now().strftime(\"%Y-%m-%d %H:%M UTC\")}\n\n'
              message += '‚ùå No value bets found today\n'
              message += 'Market efficiency is high - waiting for opportunities'
          else:
              message = 'ü§ñ **Professional ML System - Value Bets**\n\n'
              message += f'üìÖ {datetime.now().strftime(\"%Y-%m-%d %H:%M UTC\")}\n'
              message += f'üéØ {len(value_bets)} value opportunities detected\n\n'
              
              for i, bet in enumerate(value_bets[:10], 1):  # Limit to top 10
                  message += f'**{i}. {bet[\"match\"]}** ‚è∞ {bet[\"time\"]}\n'
                  message += f'   Market: {bet[\"market\"].upper()}\n'
                  message += f'   Model Prob: {bet[\"model_probability\"]} | Odds: {bet[\"market_odds\"]}\n'
                  message += f'   Edge: {bet[\"edge\"]} | EV: {bet[\"expected_value\"]}\n\n'
              
              message += '\\n‚ö†Ô∏è  Always verify odds before betting'
              message += '\\nüí∞ Use Kelly Criterion for stake sizing'
          
          # Send to Telegram
          token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          
          if token and chat_id:
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              payload = {
                  'chat_id': chat_id,
                  'text': message,
                  'parse_mode': 'Markdown'
              }
              response = requests.post(url, json=payload)
              
              if response.status_code == 200:
                  print('‚úÖ Telegram message sent successfully')
              else:
                  print(f'‚ùå Telegram failed: {response.status_code}')
          else:
              print('‚ö†Ô∏è  Telegram credentials not configured')
              print(message)
          "
      
      - name: üìä Update performance tracking
        run: |
          echo "üìà Logging predictions for CLV tracking..."
          python -c "
          import json
          from datetime import datetime
          from pathlib import Path
          
          # Load predictions
          with open('predictions.json', 'r') as f:
              predictions = json.load(f)
          
          # Append to log file
          log_file = Path('data/prediction_log.jsonl')
          log_file.parent.mkdir(parents=True, exist_ok=True)
          
          with open(log_file, 'a') as f:
              for pred in predictions:
                  log_entry = {
                      'timestamp': datetime.now().isoformat(),
                      'prediction': pred
                  }
                  f.write(json.dumps(log_entry) + '\\n')
          
          print(f'‚úÖ Logged {len(predictions)} predictions for future CLV analysis')
          "
      
      - name: üìà Commit prediction logs
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/prediction_log.jsonl || true
          git commit -m "üìä Daily predictions $(date +'%Y-%m-%d')" || true
          git push || true
